# 什么是操作日志

区别于"控制台日志"， 操作日志的存在是为了让人查看的， 所以控制台日志那种一个txt文件混在一起的情况是不符合要求的。

# 本文使用到的技术栈

- spring boot 3。0
- mybatis + mybatis-plus
- spring data jpa 
- springdoc (swagger)
- lombok

# 我们想要实现的效果

## 日志表需要记录的字段

| 字段       | 非空性 | 说明                                                         |
| ---------- | ------ | ------------------------------------------------------------ |
| 时间戳     | ✓      | 精确到秒                                                     |
| 操作类型   | ✓      | 这应该是一个枚举类型， 至少包括4种典型操作:增删改查； 可能还包括: 重置， 上传，下载，登陆，登出等 |
| 操作人     |        | 使用用户ID关联或者直接登记姓名                               |
| 操作人IP   |        | 由WEB框架提供                                                |
| 主实体类型 | ✓      | 被操作的实体类型(写包名)， 例如登陆登出的主实体类型即为 本系统的用户类 |
| 主实体ID   | ✓      | 被操作实体的唯一编号                                         |
| 副实体类型 |        |                                                              |
| 副实体ID   |        |                                                              |
| 使用的策略 |        | 描述生成策略的包名，后详                                     |
| 请求参数   |        | 请求中使用的参数 ， 因为可能存在敏感信息 ， 应当允许选择是否记录 |
| 响应结果   |        | 请求的响应内容 ， 因为可能存在敏感信息 ， 应当允许选择是否记录 |
| 操作描述   |        | **[重要]** ，后详                                            |
| 会话ID     |        | 可以通过SessionId看出用户多端登陆的情况， 与IP的含义有所不同 |
| 执行耗时   |        |                                                              |

其中：

- 副实体类型：有时候我们实际操作的是实体类B ， 但是希望该操作登记在实体类A名下，如: 用户个人信息与用户分表存储的情况 。 此时， 主实体类型 = 用户 ， 副实体类型 = 用户个人信息
- 操作描述：需要根据一定的规则(即策略)生成一段一般用户能够看懂的代表这一次操作内容的描述信息，策略应当根据被操作的实体的类型和操作类型有所不同。 同时应当有通用的默认策略，避免相同策略重复书写。对于4种典型操作而言，它的默认策略大致应该是这样的
  - 添加：`新增 [实体类型] ID:xxx [某些关键字段数据]`
  - 修改：`修改 xxx 字段，从 aa 更新为 bb`字段名应该有可读性（中文），**不记录没有修改的字段**；对于一些不太有可读性的字段（与其他表关联的外键`xxxId`， 枚举类， 内部约定的表达方式等），应该可以转换为有可读性的描述
  - 查询：`查询了 [方法名] 查询参数为 xxx`
  - 删除：`删除了 xxx`，一般情况下不应该删除主实体类(那样就不再能查询到它的日志)，而是删除了实体名下的副实体类型