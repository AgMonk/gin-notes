# 架构

- 服务注册中心、服务配置中心：Nacos
- 服务熔断、降级、流控：Sentinel，(哨兵仪表盘组件：Sentinel DashBoard)
- 服务间通信：OpenFeign（HTTP请求）
- 网关：SpringCloud Gateway



# 基础框架搭建(Docker)

## Nacos

## Sentinel DashBoard

1. 下载镜像，启动容器

```shell
docker pull bladex/sentinel-dashboard
docker run -p 8858:8858 -p 8719:8719 -e TZ="Asia/Shanghai" -d --restart always --name sentinel-dashboard bladex/sentinel-dashboard:latest
```

2. 访问sentinel-dashboard

```
http://服务器ip:8858
```
默认账号密码均为`sentinel`

3. 

# 微服务节点需要的依赖

以下依赖为绝大多数业务模块均需要引入，因此一般单独创建一个common模块，将其放入，业务模块再依赖common模块

- starter-web：基础依赖

  ```xml
  <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
  </dependency>
  ```

- nacos-discovery：微服务组件客户端

  ```xml
  <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
  </dependency>
  ```

- sentinel：sentinel客户端，接受sentinel组件的管理

  ```xml
  <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
  </dependency>
  ```

- nacos-config：从Nacos统一配置中心拉取运行配置

  ```xml
  <dependency>
      <groupId>com.alibaba.cloud</groupId>
      <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
  </dependency>
  ```

- starter-bootstrap：为了实现动态运行配置调整，需要使用bootstrap方式启动

  ```xml
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-bootstrap</artifactId>
  </dependency>
  ```

- openfeign：服务间通信

  ```xml
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-openfeign</artifactId>
  </dependency>
  ```

特别的对于网关组件，需要额外添加依赖：

- gateway：网关组件(only)

  ```xml
  <dependency>
      <groupId>org.springframework.cloud</groupId>
      <artifactId>spring-cloud-starter-gateway</artifactId>
  </dependency>
  ```

- loadbalancer：负载均衡组件

  ```xml
  <dependency>
     <groupId>org.springframework.cloud</groupId>
     <artifactId>spring-cloud-loadbalancer</artifactId>
  </dependency>
  ```

并且从common模块中排除starter-web依赖

# 压力测试工具 JMeter

## 下载

```
https://jmeter.apache.org/download_jmeter.cgi
```



# 微服务架构下的认证和鉴权(shiro)

首先，在微服务架构下，我们希望在网关组件中对请求进行统一认证和鉴权，而不是在每个业务模块中这么做也即，业务模块中不引入shiro依赖，那么：

- 不再能以注解的方式来鉴权，进而`哪个API需要那种授权`的Map格式数据（`ShiroFilterFactoryBean`中的`filterChainDefinitionMap`）需要换一种存储方式(数据库等)。
- 登陆登出的方法需要在持有shiro依赖的组件里执行，且需要写到`Controller`里；而网关组件中没有`Controller`，因此Shiro需要以一个微服务的形式存在，网关将登陆登出的接口映射到Shiro组件的对应接口上，同时Shiro组件提供一个接口
